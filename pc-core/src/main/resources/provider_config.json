{
  "config": "{\n\t\"secretKey\":\"f7d9458d592713b8cff52a3cd9939fcb\"\n}",
  "description": "聚合短信",
  "providerName": "聚合",
  "scriptContext": "import com.alibaba.fastjson.JSONObject;\nimport com.zte.msg.pushcenter.pcscript.PcScript;\n\nimport java.util.Map;\n\n\npublic class JuheSmsDemo implements PcScript {\n    public static final String DEF_CHATSET = \"UTF-8\";\n    public static final int DEF_CONN_TIMEOUT = 30000;\n    public static final int DEF_READ_TIMEOUT = 30000;\n    public static String userAgent = \"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.66 Safari/537.36\";\n\n    @Override\n    public Res execute(Map<String, Object> params) {\n        System.out.println(\"phoneNum :\" + params.get(\"phoneNum\") + \"; templateId: \" + params.get(\"templateId\") + \"; params size: \" + params.size());\n        StringBuilder var = new StringBuilder();\n        Map<String, String> vars = (Map<String, String>) params.get(\"vars\");\n        vars.forEach((k, v) -> var.append(\"#\").append(k).append(\"#\").append(\"=\").append(v).append(\"&\"));\n        String url = \"http://v.juhe.cn/sms/send?\";\n        StringBuilder url1 = new StringBuilder(url);\n        url1.append(\"mobile\").append(\"=\").append(params.get(\"phoneNum\"))\n                .append(\"&\").append(\"tpl_id\").append(\"=\").append(params.get(\"sTemplateId\"))\n                .append(\"&\").append(\"tpl_value\").append(\"=\").append(var.toString())\n                .append(\"&\").append(\"key\").append(\"=\").append(params.get(\"secretKey\"));\n\n        return parseResponse(net(url1.toString(), \"GET\"));\n    }\n\n    /**\n     * @param strUrl 请求地址\n     * @param method 请求方法\n     * @return 网络请求字符串\n     * @throws Exception\n     */\n    public static String net(String strUrl, String method) {\n//        HttpURLConnection conn = null;\n//        BufferedReader reader = null;\n//        String rs = null;\n//        StringBuilder sb = new StringBuilder();\n//        try {\n//            strUrl = strUrl.replaceAll(\"#\", URLEncoder.encode(\"#\", \"UTF-8\"));\n//            System.out.println(strUrl);\n//            URL url = new URL(strUrl);\n//            conn = (HttpURLConnection) url.openConnection();\n//            conn.setRequestMethod(method);\n//            conn.setRequestProperty(\"User-agent\", userAgent);\n//            conn.setUseCaches(false);\n//            conn.setConnectTimeout(DEF_CONN_TIMEOUT);\n//            conn.setReadTimeout(DEF_READ_TIMEOUT);\n//            conn.setInstanceFollowRedirects(false);\n//            conn.connect();\n//            InputStream is = conn.getInputStream();\n//            reader = new BufferedReader(new InputStreamReader(is, DEF_CHATSET));\n//            String strRead = null;\n//            while ((strRead = reader.readLine()) != null) {\n//                sb.append(strRead);\n//            }\n//            rs = sb.toString();\n//            reader.close();\n//        } catch (IOException e) {\n//            e.printStackTrace();\n//        } finally {\n//            if (conn != null) {\n//                conn.disconnect();\n//            }\n//        }\n\n//        return rs;\n        return \"{\\n\" +\n                \"        \\t\\\"reason\\\":\\\"操作成功\\\",\\n\" +\n                \"        \\t\\\"result\\\":{\\n\" +\n                \"        \\t\\t\\\"sid\\\":\\\"1428ADC382FEDE59\\\",\\n\" +\n                \"        \\t\\t\\\"fee\\\":1,\\n\" +\n                \"        \\t\\t\\\"count\\\":1\\n\" +\n                \"        \\t},\\n\" +\n                \"        \\t\\\"error_code\\\":0\\n\" +\n                \"        }\";\n\n    }\n\n\n    private Res parseResponse(String res) {\n//        {\n//        \t\"reason\":\"操作成功\",\n//        \t\"result\":{\n//        \t\t\"sid\":\"1428ADC382FEDE59\",\n//        \t\t\"fee\":1,\n//        \t\t\"count\":1\n//        \t},\n//        \t\"error_code\":0\n//        }\n        JSONObject resObj = JSONObject.parseObject(res);\n        ErrorCodes errorCode = ErrorCodes.find(resObj.getString(\"error_code\"));\n\n        return new Res(errorCode.getPcCode(), resObj.getString(\"reason\"));\n    }\n\n    public enum ErrorCodes {\n\n        ERROR_PHONE_NUM(\"205401\", 32100001, \"错误的手机号码\"),\n\n        ERROR_TEMPLATE_ID(\"205402\", 32100002, \"错误的模版id\"),\n\n        NET_ERROR(\"205403\", 32100003, \"网络错误\"),\n\n        EXCEED_LIMIT(\"205405\", 32100004, \"号码异常/同一号码发送次数过于频繁\"),\n\n        ERROR_KEY(\"10001\", 32100005, \"错误的请求KEY\"),\n\n        PERMISSION_DEFINED_KEY(\"10002\", 32100005, \"该KEY无请求权限\"),\n\n        SUCCESS(\"0\", 0, \"成功\"),\n\n        UNKNOWN(\"-1\", -1, \"位置错误\");\n\n        private String code;\n\n        private Integer pcCode;\n\n        private String message;\n\n        ErrorCodes(String code, Integer pcCode, String message) {\n            this.code = code;\n            this.pcCode = pcCode;\n            this.message = message;\n        }\n\n        private static ErrorCodes find(String code) {\n            for (ErrorCodes errorCode : ErrorCodes.values()) {\n                if (errorCode.code.equals(code)) {\n                    return errorCode;\n                }\n            }\n            return UNKNOWN;\n        }\n\n        public String getCode() {\n            return code;\n        }\n\n        public Integer getPcCode() {\n            return pcCode;\n        }\n\n        public String getMessage() {\n            return message;\n        }\n    }\n}",
  "type": 1
}

{
  "config": "{\n\t\"appId\":\"1400465545\",\n\t\"secretId\":\"AKIDyid2EePjPs75ljCt6qMbWDfrtf7h9JFv\",\n\t\"secretKey\":\"INDn8zKQHuLYUDOM9dqo68tPnunQEo86\"\n}",
  "description": "腾讯短信",
  "providerName": "腾讯云",
  "scriptContext": "import javax.crypto.Mac;\nimport javax.crypto.spec.SecretKeySpec;\nimport javax.xml.bind.DatatypeConverter;\nimport java.nio.charset.Charset;\nimport java.nio.charset.StandardCharsets;\nimport java.security.MessageDigest;\nimport java.text.SimpleDateFormat;\nimport java.util.Date;\nimport java.util.TimeZone;\nimport java.util.TreeMap;\n\n/**\n * description:\n *\n * @author chentong\n * @version 1.0\n * @date 2020/12/22 10:36\n */\npublic class TencentSmsDemo {\n\n    private final static Charset UTF8 = StandardCharsets.UTF_8;\n    private final static String SECRET_ID = \"xxx\";\n    private final static String SECRET_KEY = \"xxx\";\n    private final static String CT_JSON = \"application/json\";\n\n    public static byte[] hmac256(byte[] key, String msg) throws Exception {\n        Mac mac = Mac.getInstance(\"HmacSHA256\");\n        SecretKeySpec secretKeySpec = new SecretKeySpec(key, mac.getAlgorithm());\n        mac.init(secretKeySpec);\n        return mac.doFinal(msg.getBytes(UTF8));\n    }\n\n    public static String sha256Hex(String s) throws Exception {\n        MessageDigest md = MessageDigest.getInstance(\"SHA-256\");\n        byte[] d = md.digest(s.getBytes(UTF8));\n        return DatatypeConverter.printHexBinary(d).toLowerCase();\n    }\n\n    public static void main(String[] args) throws Exception {\n        String service = \"sms\";\n        String host = \"sms.tencentcloudapi.com\";\n//        String region = \"ap-guangzhou\";\n        String action = \"SendSms\";\n        String version = \"2019-07-11\";\n        String algorithm = \"TC3-HMAC-SHA256\";\n        String timestamp = String.valueOf(System.currentTimeMillis() / 1000);\n        SimpleDateFormat sdf = new SimpleDateFormat(\"yyyy-MM-dd\");\n        // 注意时区，否则容易出错\n        sdf.setTimeZone(TimeZone.getTimeZone(\"UTC\"));\n        String date = sdf.format(new Date(Long.valueOf(timestamp + \"000\")));\n\n        // ************* 步骤 1：拼接规范请求串 *************\n        String httpRequestMethod = \"POST\";\n        String canonicalUri = \"/\";\n        String canonicalQueryString = \"\";\n        String canonicalHeaders = \"content-type:application/json\\n\" + \"host:\" + host + \"\\n\";\n        String signedHeaders = \"content-type;host\";\n\n        String payload = \"{\\\"PhoneNumberSet\\\":[\\\"+8618349342711\\\"],\\\"TemplateParamSet\\\":[\\\"152525\\\"],\\\"TemplateID\\\":\\\"821098\\\",\\\"SmsSdkAppid\\\":\\\"1400465545\\\",\\\"Sign\\\":\\\"中兴轨道通讯\\\"}\";\n        String hashedRequestPayload = sha256Hex(payload);\n        String canonicalRequest = httpRequestMethod + \"\\n\" + canonicalUri + \"\\n\" + canonicalQueryString + \"\\n\"\n                + canonicalHeaders + \"\\n\" + signedHeaders + \"\\n\" + hashedRequestPayload;\n        System.out.println(\"canonicalRequest: \" + canonicalRequest);\n\n        // ************* 步骤 2：拼接待签名字符串 *************\n        String credentialScope = date + \"/\" + service + \"/\" + \"tc3_request\";\n        String hashedCanonicalRequest = sha256Hex(canonicalRequest);\n        String stringToSign = algorithm + \"\\n\" + timestamp + \"\\n\" + credentialScope + \"\\n\" + hashedCanonicalRequest;\n        System.out.println(\"stringToSign: \" + stringToSign);\n\n        // ************* 步骤 3：计算签名 *************\n        byte[] secretDate = hmac256((\"TC3\" + SECRET_KEY).getBytes(UTF8), date);\n        byte[] secretService = hmac256(secretDate, service);\n        byte[] secretSigning = hmac256(secretService, \"tc3_request\");\n        String signature = DatatypeConverter.printHexBinary(hmac256(secretSigning, stringToSign)).toLowerCase();\n        System.out.println(\"signature: \" + signature);\n\n        // ************* 步骤 4：拼接 Authorization *************\n        String authorization = algorithm + \" \" + \"Credential=\" + SECRET_ID + \"/\" + credentialScope + \", \"\n                + \"SignedHeaders=\" + signedHeaders + \", \" + \"Signature=\" + signature;\n        System.out.println(\"authorization为: \" + authorization);\n\n        TreeMap<String, String> headers = new TreeMap<String, String>();\n        headers.put(\"Authorization\", authorization);\n        headers.put(\"Content-Type\", CT_JSON);\n        headers.put(\"Host\", host);\n        headers.put(\"X-TC-Action\", action);\n        headers.put(\"X-TC-Timestamp\", timestamp);\n        headers.put(\"X-TC-Version\", version);\n//        headers.put(\"X-TC-Region\", region);\n\n        StringBuilder sb = new StringBuilder();\n        sb.append(\"curl -X POST https://\").append(host)\n                .append(\" -H \\\"Authorization: \").append(authorization).append(\"\\\"\")\n                .append(\" -H \\\"Content-Type: application/json\\\"\")\n                .append(\" -H \\\"Host: \").append(host).append(\"\\\"\")\n                .append(\" -H \\\"X-TC-Action: \").append(action).append(\"\\\"\")\n                .append(\" -H \\\"X-TC-Timestamp: \").append(timestamp).append(\"\\\"\")\n                .append(\" -H \\\"X-TC-Version: \").append(version).append(\"\\\"\")\n                .append(\" -H \\\"X-TC-Language: \").append(\"zh-CN\").append(\"\\\"\")\n//                .append(\" -H \\\"X-TC-Region: \").append(region).append(\"\\\"\")\n                .append(\" -d '\").append(payload).append(\"'\");\n        System.out.println(sb.toString());\n    }\n\n\n}",
  "type": 1
}